#!/usr/bin/env bash
#
# startx + sharing is caring

set -e

out() {
  echo "[SHAREX] $*"
}

startx &
sleep 5

out "sharing xauth with any other sidecars"
DISPLAY=":$(xauth list | awk '{ print $1 }' | awk -F ':' '{ print $2 }' | head -n1)"

out "display $DISPLAY"
xauth extract - "${DISPLAY}" > /mnt/xauth/.Xauthority
echo "$DISPLAY" > /mnt/xauth/display

out "shared xauth successfully"

out "sharing X over TCP"
exec socat -d -d TCP-LISTEN:6000,bind=localhost UNIX-CONNECT:/tmp/.X11-unix/X0